<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usage &mdash; v-met  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Complete Parameter Reference" href="parameters.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> v-met
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#input-preparation">Input Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#profile-selection">Profile Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mandatory-parameters">Mandatory Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-for-hpc-job-schedulers">Setting up for HPC Job Schedulers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#process-labels">Process Labels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="parameters.html">Complete Parameter Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">v-met</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Usage</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/usage.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline"></a></h1>
<p>Basic jist:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nextflow</span> <span class="n">run</span> <span class="n">ksumngs</span><span class="o">/</span><span class="n">v</span><span class="o">-</span><span class="n">met</span> <span class="o">-</span><span class="n">profile</span> <span class="o">&lt;</span><span class="n">docker</span><span class="p">,</span><span class="n">podman</span><span class="p">,</span><span class="n">singularity</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">platform</span> <span class="o">&lt;</span><span class="n">pe</span><span class="p">,</span><span class="n">ont</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">kraken2_db</span> <span class="o">&lt;</span><span class="n">kraken2_db</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">blast_db</span> <span class="o">&lt;</span><span class="n">blast_db</span><span class="o">&gt;</span>
</pre></div>
</div>
<section id="input-preparation">
<h2>Input Preparation<a class="headerlink" href="#input-preparation" title="Permalink to this headline"></a></h2>
<p>Input is made up of raw NGS reads in gzipped fastq format. There must be only
one file per sample for Nanopore reads, and one pair of files (two files) for
Illumina paired-end reads. Paired-end files must have either the characters
<code class="docutils literal notranslate"><span class="pre">_1</span></code> and <code class="docutils literal notranslate"><span class="pre">_2</span></code> or <code class="docutils literal notranslate"><span class="pre">_R1</span></code> and <code class="docutils literal notranslate"><span class="pre">_R2</span></code> in the filename to be idenfied as a
pair. Note that this pipeline does not support Illumina single-end reads. The
sample name is taken as the all the characters <em>before</em> the first underscore in
the file name.</p>
<p>For example, a folder with the following files</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── pig-serum_S4_L001_R1_001.fastq.gz
├── pig-serum_S4_L001_R2_001.fastq.gz
├── pig-feces_S5_L001_R1_001.fastq.gz
├── pig-feces_S5_L001_R2_001.fastq.gz
├── mosquito1_S6_L001_R1_001.fastq.gz
├── mosquito1_S6_L001_R2_001.fastq.gz
├── mosquito2_S7_L001_R1_001.fastq.gz
└── mosquito2_S7_L001_R2_001.fastq.gz
</pre></div>
</div>
<p>will produce a sample list of</p>
<ul class="simple">
<li><p>pig-serum</p></li>
<li><p>pig-feces</p></li>
<li><p>mosquito1</p></li>
<li><p>mosquito2</p></li>
</ul>
<p>This file naming system is very common for Illumina output, however the default
Oxford Nanopore naming scheme breaks this in several ways:</p>
<ol class="arabic simple">
<li><p>The fastq files are (often) not gzipped</p></li>
<li><p>The fastq files are stored in separate directories per sample</p></li>
<li><p>The fastq files start with the flowcell id as the beginning of the filename</p></li>
<li><p>There are often many fastq files per sample</p></li>
</ol>
<p>For example, MinION output folders often are structured like the following</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── fastq_fail
│   ├── barcode04
|   |   ├── FAP01234_fail_barcode04_abcd1234_0.fastq
|   |   └── FAP01234_fail_barcode04_abcd1234_1.fastq
|   ├── barcode05
|   |   ├── FAP01234_fail_barcode05_abcd1234_0.fastq
|   |   └── FAP01234_fail_barcode05_abcd1234_1.fastq
│   ├── barcode06
|   |   └── FAP01234_fail_barcode06_abcd1234_0.fastq
|   └── barcode07
|       ├── FAP01234_fail_barcode07_abcd1234_0.fastq
|       └── FAP01234_fail_barcode07_abcd1234_1.fastq
└── fastq_pass
    ├── barcode04
    |   ├── FAP01234_pass_barcode04_abcd1234_0.fastq
    |   └── FAP01234_pass_barcode04_abcd1234_1.fastq
    ├── barcode05
    |   ├── FAP01234_pass_barcode05_abcd1234_0.fastq
    |   └── FAP01234_pass_barcode05_abcd1234_1.fastq
    ├── barcode06
    |   └── FAP01234_pass_barcode06_abcd1234_0.fastq
    └── barcode07
        ├── FAP01234_pass_barcode07_abcd1234_0.fastq
        └── FAP01234_pass_barcode07_abcd1234_1.fastq
</pre></div>
</div>
<p>(Non-fastq files and directories excluded for brevity.)</p>
<p>One way of remedying these difficulties is to create a tab-separated file with
the sample ID and the barcode (with leading zeros), such as</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 56%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>sample</p></th>
<th class="head"><p>barcode</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>pig-serum</p></td>
<td><p>04</p></td>
</tr>
<tr class="row-odd"><td><p>pig-feces</p></td>
<td><p>05</p></td>
</tr>
<tr class="row-even"><td><p>mosquito1</p></td>
<td><p>06</p></td>
</tr>
<tr class="row-odd"><td><p>mosquito2</p></td>
<td><p>07</p></td>
</tr>
</tbody>
</table>
<p>Then the following bash script can restructure the files into the correct
format using GNU Parallel and pigz, and can handle a mix of gzipped and
uncompressed reads. Replace <code class="docutils literal notranslate"><span class="pre">fastq*</span></code> with <code class="docutils literal notranslate"><span class="pre">fastq_pass</span></code> in line 8 if you
wish to only consider those reads that passed Guppy’s quality checks.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">SAMPLESHEET</span><span class="o">=</span>/path/to/samplesheet
<span class="nv">MINION_DIR</span><span class="o">=</span>/path/to/minion/output
<span class="k">while</span> <span class="nb">read</span> -r LINE<span class="p">;</span> <span class="k">do</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$LINE</span><span class="s2">&quot;</span> <span class="p">|</span> <span class="k">while</span> <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\t&#39;</span> <span class="nb">read</span> -r SAMPLE BARCODE<span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$SAMPLE</span> !<span class="o">=</span> <span class="s2">&quot;sample&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      mkdir <span class="nv">$SAMPLE</span>
      cp <span class="si">${</span><span class="nv">MINION_DIR</span><span class="si">}</span>/fastq*/barcode<span class="si">${</span><span class="nv">BARCODE</span><span class="si">}</span>/*.fastq* <span class="nv">$SAMPLE</span>
      parallel gunzip ::: <span class="nv">$SAMPLE</span>/*.fastq.gz
      cat <span class="nv">$SAMPLE</span>/*.fastq &gt; <span class="nv">$SAMPLE</span>.fastq
      pigz --best -p <span class="k">$(</span>nproc<span class="k">)</span> <span class="nv">$SAMPLE</span>.fastq
      rm -rf <span class="nv">$SAMPLE</span>
    <span class="k">fi</span>
  <span class="k">done</span>
<span class="k">done</span> &lt; <span class="nv">$SAMPLESHEET</span>
</pre></div>
</div>
<p>Running this script on the example directory and sample sheet will yield the
following files</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── pig-serum.fastq.gz
├── pig-feces.fastq.gz
├── mosquito1.fastq.gz
└── mosquito2.fastq.gz
</pre></div>
</div>
<p>and will give the same sample names as given above for the Illumina files. Note
that fast5 files are not needed for Nanopore reads.</p>
</section>
<section id="profile-selection">
<h2>Profile Selection<a class="headerlink" href="#profile-selection" title="Permalink to this headline"></a></h2>
<p>Profiles allow for unique combinations of settings within a Nextflow pipeline.
For the purposes of jev-analysis-pipeline, they reconfigure the pipeline to run
on a particular container engine. Whichever engine you choose must be installed
and available (e.g. <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span></code>) on each node that pipeline processes are
running on. The available options are</p>
<dl>
<dt>(none)</dt><dd><p>Don’t use a container engine. Requires that every tool and the right version
of every tool be installed on each machine the pipeline is running on. Don’t
use this one.</p>
</dd>
<dt>docker</dt><dd><p>Use <a class="reference external" href="https://docker.com">Docker</a> as the container engine. Note that Docker
often requires root or nearly-root permissions that usually aren’t available
on HPCs, and has a weird license that might forbid its use in commercial
settings. Works well on local machines, though.</p>
</dd>
<dt>podman</dt><dd><p>Use <a class="reference external" href="https://podman.io">Podman</a> instead of Docker. Podman is similar enough
to Docker that they can often be used interchangably, but doesn’t require root
permissions and has a free license. Some files might not be accessible via
container on RHEL-based distros thanks to their particular SELinux
implementation.</p>
</dd>
<dt>singularity</dt><dd><p><strong>Recommended</strong></p>
<p>Use the
<a class="reference external" href="https://singularity.hpcng.org/user-docs/3.8/index.html" title="(in Singularity User Guide v3.8)"><span class="xref std std-doc">Singularity</span></a> container enginer.
This engine was build with HPC use in mind, and doesn’t require any special
permissions to run. Singularity’s downfall is how it will expose your home
directory to the container, resulting in rare, but difficult to explain bugs
when files conflict. Every effort has been made to minimize the effects of
Singularity’s file mounting in this pipeline.</p>
</dd>
</dl>
<p>To select a profile, you must pass the desired profile name to Nextflow’s
<code class="docutils literal notranslate"><span class="pre">-profile</span></code> flag. Note that this is a Nextflow flag, and not a pipeline flag,
so it is a single dash (<code class="docutils literal notranslate"><span class="pre">-profile</span></code>), not a double dash (<code class="docutils literal notranslate"><span class="pre">--profile</span></code>).</p>
</section>
<section id="mandatory-parameters">
<h2>Mandatory Parameters<a class="headerlink" href="#mandatory-parameters" title="Permalink to this headline"></a></h2>
<p>See <a class="reference internal" href="parameters.html"><span class="doc">the page on parameters</span></a> for the complete lowdown on
parameters.</p>
<p>The pipeline is pretty much set up to run itself. So long as you have your input
reads formatted correctly, it doesn’t need much input from you. These are the
bare minimum parameters that you must provide on the command-line for the
pipeline to complete. Note that there has been mixed success with placing these
parameters in a <code class="docutils literal notranslate"><span class="pre">nextflow.config</span></code> file, so keeping them on the command-line is
best.</p>
<dl class="option-list">
<dt><kbd><span class="option">--kraken2_db</span></kbd></dt>
<dd><p>The path to a Kraken2 database. See <a class="reference internal" href="parameters.html#kraken2-db"><span class="std std-ref">–kraken2_db</span></a>.</p>
</dd>
<dt><kbd><span class="option">--blast_db</span></kbd></dt>
<dd><p>The path to an NCBI nt BLAST database. See <a class="reference internal" href="parameters.html#blast-db"><span class="std std-ref">–blast_db</span></a>.</p>
</dd>
<dt><kbd><span class="option">--platform</span></kbd></dt>
<dd><p>Must be set to <code class="docutils literal notranslate"><span class="pre">ont</span></code> or <code class="docutils literal notranslate"><span class="pre">pe</span></code>, depending on the type of reads you are
analyzing. See <a class="reference internal" href="parameters.html#platform"><span class="std std-ref">–platform</span></a>.</p>
</dd>
<dt><kbd><span class="option">-p<var>rofile</var></span></kbd></dt>
<dd><p>So, this isn’t really a parameter, but the container engine needs to be set
using Nextflow’s <code class="docutils literal notranslate"><span class="pre">-profile</span></code> flag. See <a class="reference internal" href="#profile-selection"><span class="std std-ref">Profile Selection</span></a>.</p>
</dd>
</dl>
</section>
<section id="setting-up-for-hpc-job-schedulers">
<h2>Setting up for HPC Job Schedulers<a class="headerlink" href="#setting-up-for-hpc-job-schedulers" title="Permalink to this headline"></a></h2>
<p>v-met comes preconfigured for local use only. Yes, that’s about as ridiculous as
it sounds. What’s even more ridiculous is trying to make a configuration that
can easily be adapted to multiple HPCs and job-scheduler frameworks. There is a
compromise, however.</p>
<section id="process-labels">
<h3>Process Labels<a class="headerlink" href="#process-labels" title="Permalink to this headline"></a></h3>
<p>Rather than provide hard-coded configurations that will certainly
break, there are several Nextflow ‘labels,’ that can be used for assigning
processes to specific node queues or partitions. The labels are</p>
<dl class="simple">
<dt>process_low</dt><dd><p>For processes with low resource usage that take a short time</p>
</dd>
<dt>process_medium</dt><dd><p>For processes with moderate resource usage that take a moderate amount of time</p>
</dd>
<dt>process_high</dt><dd><p>For processes with high resource usage that take a moderately high amount of
time</p>
</dd>
<dt>process_long</dt><dd><p>For processes that take a long time</p>
</dd>
<dt>process_high_memory</dt><dd><p>For processes that use a lot of memory</p>
</dd>
<dt>run_local</dt><dd><p>For processes that have to be run on the login node. This label was created
specially for processes that download resources from the internet on HPCs
where compute nodes do not have internet access</p>
</dd>
</dl>
<p>Using a custom <code class="docutils literal notranslate"><span class="pre">nextflow.config</span></code> and these process labels, you can construct a
setup for your own HPC needs.</p>
</section>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline"></a></h3>
<p>As an example, here is a guide on how to set up a configuration for the
<a class="reference external" href="https://scinet.usda.gov/guide/ceres/">USDA’s SCINet Ceres cluster</a>, using the
publically available info on their website.</p>
<p>First, we see that Ceres uses SLURM and Singularity. Excellent.
Let’s set Nextflow up to use SLURM:</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">process</span> <span class="o">{</span>
    <span class="n">executor</span> <span class="o">=</span> <span class="s1">&#39;slurm&#39;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Some SLURM systems require an account to be passed with every job submission.
Let’s add ours just to be safe.</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">process</span> <span class="o">{</span>
    <span class="n">executor</span>       <span class="o">=</span> <span class="s1">&#39;slurm&#39;</span>
    <span class="n">clusterOptions</span> <span class="o">=</span> <span class="s1">&#39;--account=ksumngs&#39;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>For this example, I don’t think we’ll need to do anything special with the low,
medium, and high processes, but let’s make sure that the long and high memory
processes get submitted to partitions that can handle them.</p>
<div class="highlight-groovy notranslate"><div class="highlight"><pre><span></span><span class="n">process</span> <span class="o">{</span>
    <span class="n">executor</span>       <span class="o">=</span> <span class="s1">&#39;slurm&#39;</span>
    <span class="n">clusterOptions</span> <span class="o">=</span> <span class="s1">&#39;--account=ksumngs&#39;</span>
    <span class="n">module</span>         <span class="o">=</span> <span class="s1">&#39;singularity&#39;</span>
    <span class="nl">withLabel:</span> <span class="n">process_long</span> <span class="o">{</span>
        <span class="n">queue</span>      <span class="o">=</span> <span class="s1">&#39;long&#39;</span>
    <span class="o">}</span>
    <span class="nl">withLabel:</span> <span class="n">process_high_memory</span> <span class="o">{</span>
        <span class="n">queue</span>      <span class="o">=</span> <span class="s1">&#39;mem&#39;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Now, we can place this file in <code class="docutils literal notranslate"><span class="pre">$HOME/.nextflow/nextflow.config</span></code>, and these
settings will be applied every time we run the pipeline.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="install.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="parameters.html" class="btn btn-neutral float-right" title="Complete Parameter Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, K-State Molecular NGS Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>